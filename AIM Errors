using AIM.Models;
using System. Collections.Generic;

namespace AIM.Services;

/// <summary>
/// Service to intelligently paginate printable form content.
/// </summary>
public class PrintPaginationService
{
    // Page dimensions at 96 DPI (8.5" x 11" letter size)
    private const double PageHeight = 1056;
    private const double PageWidth = 816;
    private const double TopMargin = 40;
    private const double BottomMargin = 40;
    
    // Element heights (approximate, in pixels at 96 DPI)
    private const double HeaderHeight = 70;        // Page header with title, subtitle, initials
    private const double Level2HeaderHeight = 40;  // Yellow section header
    private const double Level3HeaderHeight = 28;  // Green/Blue/Red subsection headers  
    private const double FileRowHeight = 24;       // Standard file row
    private const double BlankRowHeight = 20;      // Blank row
    private const double FooterHeight = 45;        // Footer with page number
    
    // Minimum rows to include with a header (prevents orphaned headers)
    private const int MinRowsWithLevel2Header = 3;
    private const int MinRowsWithLevel3Header = 2;

    /// <summary>
    /// Calculates available content height per page.
    /// </summary>
    private double GetAvailableContentHeight(bool hasLevel2Header)
    {
        double usedHeight = TopMargin + BottomMargin + HeaderHeight + FooterHeight;
        if (hasLevel2Header)
        {
            usedHeight += Level2HeaderHeight;
        }
        return PageHeight - usedHeight;
    }

    /// <summary>
    /// Gets the height of a row based on its type.
    /// </summary>
    private double GetRowHeight(PrintableFormItem item)
    {
        return item.Type switch
        {
            RowType.Level2Header => Level2HeaderHeight,
            RowType.Level3Header_A => Level3HeaderHeight,
            RowType.Level3Header_B => Level3HeaderHeight,
            RowType.Level3Header_C => Level3HeaderHeight,
            RowType. File => FileRowHeight,
            RowType.Blank => BlankRowHeight,
            _ => FileRowHeight
        };
    }

    /// <summary>
    /// Checks if a row is a Level 3 header type.
    /// </summary>
    private bool IsLevel3Header(RowType type)
    {
        return type == RowType.Level3Header_A || 
               type == RowType. Level3Header_B || 
               type == RowType.Level3Header_C;
    }

    /// <summary>
    /// Counts how many content rows follow a header at the given index.
    /// </summary>
    private int CountFollowingContentRows(List<PrintableFormItem> allRows, int headerIndex)
    {
        int count = 0;
        for (int i = headerIndex + 1; i < allRows. Count; i++)
        {
            var rowType = allRows[i].Type;
            if (rowType == RowType.Level2Header || IsLevel3Header(rowType))
            {
                break; // Hit another header, stop counting
            }
            if (rowType == RowType. File)
            {
                count++;
            }
        }
        return count;
    }

    /// <summary>
    /// Calculates the height needed for a header plus minimum following rows.
    /// </summary>
    private double GetHeaderWithMinContentHeight(PrintableFormItem header, List<PrintableFormItem> allRows, int headerIndex)
    {
        double height = GetRowHeight(header);
        int minRows = header.Type == RowType.Level2Header ? MinRowsWithLevel2Header : MinRowsWithLevel3Header;
        int rowsAdded = 0;

        for (int i = headerIndex + 1; i < allRows.Count && rowsAdded < minRows; i++)
        {
            var row = allRows[i];
            if (row.Type == RowType.Level2Header || IsLevel3Header(row.Type))
            {
                break; // Hit another header
            }
            height += GetRowHeight(row);
            rowsAdded++;
        }

        return height;
    }

    /// <summary>
    /// Paginates a flat list of form items into properly sized pages.
    /// </summary>
    public List<PrintablePage> PaginateContent(
        string pageHeader,
        string level2Header,
        List<PrintableFormItem> allRows)
    {
        var pages = new List<PrintablePage>();
        var currentPageRows = new List<PrintableFormItem>();
        double currentPageUsedHeight = 0;
        double availableHeight = GetAvailableContentHeight(! string.IsNullOrEmpty(level2Header));
        string currentLevel2Header = level2Header;
        bool isFirstPage = true;

        for (int i = 0; i < allRows.Count; i++)
        {
            var row = allRows[i];
            double rowHeight = GetRowHeight(row);

            // Check if this is a header that needs special handling
            bool isLevel2 = row.Type == RowType.Level2Header;
            bool isLevel3 = IsLevel3Header(row.Type);

            if (isLevel2 || isLevel3)
            {
                // Calculate space needed for header + minimum content
                double headerWithContentHeight = GetHeaderWithMinContentHeight(row, allRows, i);

                // Check if header + min content fits on current page
                if (currentPageUsedHeight + headerWithContentHeight > availableHeight)
                {
                    // Not enough room - finish current page and start new one
                    if (currentPageRows.Count > 0)
                    {
                        // Fill remaining space with blank rows
                        FillWithBlankRows(currentPageRows, availableHeight - currentPageUsedHeight);

                        pages.Add(CreatePage(pageHeader, currentLevel2Header, currentPageRows, isFirstPage));
                        isFirstPage = false;
                        currentPageRows = new List<PrintableFormItem>();
                        currentPageUsedHeight = 0;
                    }

                    // Update Level2 header if this is a new Level2
                    if (isLevel2)
                    {
                        currentLevel2Header = row.Content;
                        availableHeight = GetAvailableContentHeight(true);
                    }
                }
                else if (isLevel2)
                {
                    // Level2 header fits - update the current level2 header
                    currentLevel2Header = row.Content;
                }
            }

            // Check if row fits on current page
            if (currentPageUsedHeight + rowHeight > availableHeight)
            {
                // Fill remaining space with blank rows
                FillWithBlankRows(currentPageRows, availableHeight - currentPageUsedHeight);

                // Start new page
                pages.Add(CreatePage(pageHeader, currentLevel2Header, currentPageRows, isFirstPage));
                isFirstPage = false;
                currentPageRows = new List<PrintableFormItem>();
                currentPageUsedHeight = 0;
                availableHeight = GetAvailableContentHeight(!string.IsNullOrEmpty(currentLevel2Header));
            }

            // Add row to current page (skip Level2 headers as they're shown in the page header area)
            if (row.Type != RowType.Level2Header)
            {
                currentPageRows.Add(row);
                currentPageUsedHeight += rowHeight;
            }
        }

        // Add final page if there's remaining content
        if (currentPageRows.Count > 0)
        {
            // Fill remaining space with blank rows
            FillWithBlankRows(currentPageRows, availableHeight - currentPageUsedHeight);
            pages.Add(CreatePage(pageHeader, currentLevel2Header, currentPageRows, isFirstPage));
        }

        // Update page numbers
        for (int i = 0; i < pages.Count; i++)
        {
            pages[i]. PageNumber = i + 1;
            pages[i].TotalPages = pages.Count;
        }

        return pages;
    }

    /// <summary>
    /// Fills remaining page space with blank rows.
    /// </summary>
    private void FillWithBlankRows(List<PrintableFormItem> rows, double remainingHeight)
    {
        while (remainingHeight >= BlankRowHeight)
        {
            rows.Add(new PrintableFormItem { Type = RowType.Blank, Content = string.Empty });
            remainingHeight -= BlankRowHeight;
        }
    }

    /// <summary>
    /// Creates a PrintablePage with the given content. 
    /// </summary>
    private PrintablePage CreatePage(
        string pageHeader,
        string level2Header,
        List<PrintableFormItem> rows,
        bool isFirstPage)
    {
        return new PrintablePage
        {
            PageHeader = pageHeader,
            Level2Header = level2Header,
            Rows = new List<PrintableFormItem>(rows),
            IsContinuationPage = ! isFirstPage
        };
    }
}
