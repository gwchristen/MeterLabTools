using AIM.Models;
using System. Collections.Generic;
using System. Diagnostics;

namespace AIM.Services;

public class PrintPaginationService : IPrintPaginationService
{
    // Page dimensions at 96 DPI (8.5" x 11" letter size)
    private const double PageHeight = 1056;
    private const double PageWidth = 816;
    private const double TopMargin = 40;
    private const double BottomMargin = 40;

    // Element heights - ADJUST THESE to match your actual rendered sizes
    // If pages are cutting off too early, DECREASE these values
    private const double HeaderHeight = 60;        // Page header with title, subtitle, initials (was 70)
    private const double Level2HeaderHeight = 35;  // Yellow section header (was 40)
    private const double Level3HeaderHeight = 24;  // Green/Blue/Red subsection headers (was 28)
    private const double FileRowHeight = 20;       // Standard file row (was 24)
    private const double BlankRowHeight = 20;      // Blank row
    private const double FooterHeight = 40;        // Footer with page number (was 45)

    // Minimum rows to include with a header (prevents orphaned headers)
    private const int MinRowsWithLevel2Header = 3;
    private const int MinRowsWithLevel3Header = 8;

    /// <summary>
    /// Calculates available content height per page. 
    /// </summary>
    private double GetAvailableContentHeight(bool hasLevel2Header)
    {
        double usedHeight = TopMargin + BottomMargin + HeaderHeight + FooterHeight;
        if (hasLevel2Header)
        {
            usedHeight += Level2HeaderHeight;
        }
        double available = PageHeight - usedHeight;
        
        Debug.WriteLine($"=== GetAvailableContentHeight ===");
        Debug.WriteLine($"Page Height: {PageHeight}");
        Debug.WriteLine($"Used Height: {usedHeight} (Margins: {TopMargin + BottomMargin}, Header: {HeaderHeight}, Footer: {FooterHeight}, Level2: {(hasLevel2Header ? Level2HeaderHeight : 0)})");
        Debug.WriteLine($"Available for content: {available}");
        
        return available;
    }

    /// <summary>
    /// Gets the height of a row based on its type. 
    /// </summary>
    private double GetRowHeight(PrintableFormItem item)
    {
        return item.Type switch
        {
            RowType.Level2Header => Level2HeaderHeight,
            RowType.Level3Header_A => Level3HeaderHeight,
            RowType.Level3Header_B => Level3HeaderHeight,
            RowType.Level3Header_C => Level3HeaderHeight,
            RowType. File => FileRowHeight,
            RowType.Blank => BlankRowHeight,
            _ => FileRowHeight
        };
    }

    /// <summary>
    /// Checks if a row is a Level 3 header type.
    /// </summary>
    private bool IsLevel3Header(RowType type)
    {
        return type == RowType.Level3Header_A ||
               type == RowType. Level3Header_B ||
               type == RowType.Level3Header_C;
    }

    /// <summary>
    /// Calculates the height needed for a header plus minimum following rows.
    /// </summary>
    private double GetHeaderWithMinContentHeight(PrintableFormItem header, List<PrintableFormItem> allRows, int headerIndex)
    {
        double height = GetRowHeight(header);
        int minRows = header.Type == RowType.Level2Header ?  MinRowsWithLevel2Header : MinRowsWithLevel3Header;
        int rowsAdded = 0;

        for (int i = headerIndex + 1; i < allRows. Count && rowsAdded < minRows; i++)
        {
            var row = allRows[i];
            if (row.Type == RowType.Level2Header || IsLevel3Header(row.Type))
            {
                break; // Hit another header
            }
            height += GetRowHeight(row);
            rowsAdded++;
        }

        Debug.WriteLine($"Header '{header.Content}' needs {height}px for header + {rowsAdded} min rows");
        return height;
    }

    /// <summary>
    /// Paginates a flat list of form items into properly sized pages.
    /// </summary>
    public List<PrintablePage> PaginateContent(string pageHeader, List<PrintableFormItem> allRows)
    {
        Debug.WriteLine($"=== PaginateContent START - {allRows.Count} total rows ===");
        
        var pages = new List<PrintablePage>();
        var currentPageRows = new List<PrintableFormItem>();
        double currentPageUsedHeight = 0;
        string currentLevel2Header = string.Empty;
        double availableHeight = GetAvailableContentHeight(false);
        bool isFirstPageForLevel2 = true;
        int pageNum = 1;

        for (int i = 0; i < allRows.Count; i++)
        {
            var row = allRows[i];
            double rowHeight = GetRowHeight(row);

            bool isLevel2 = row.Type == RowType.Level2Header;
            bool isLevel3 = IsLevel3Header(row.Type);

            if (isLevel2)
            {
                // Starting a new Level 2 section
                if (currentPageRows.Count > 0)
                {
                    Debug.WriteLine($"--- Finishing page {pageNum} with {currentPageRows.Count} rows (used {currentPageUsedHeight}px of {availableHeight}px) ---");
                    FillWithBlankRows(currentPageRows, availableHeight - currentPageUsedHeight);
                    pages.Add(CreatePage(pageHeader, currentLevel2Header, currentPageRows, ! isFirstPageForLevel2));
                    pageNum++;
                    currentPageRows = new List<PrintableFormItem>();
                    currentPageUsedHeight = 0;
                }

                currentLevel2Header = row.Content;
                availableHeight = GetAvailableContentHeight(true);
                isFirstPageForLevel2 = true;
                Debug.WriteLine($"=== New Level2 Section: '{currentLevel2Header}' - Available height: {availableHeight}px ===");
                continue;
            }

            if (isLevel3)
            {
                double headerWithContentHeight = GetHeaderWithMinContentHeight(row, allRows, i);

                if (currentPageUsedHeight + headerWithContentHeight > availableHeight && currentPageRows.Count > 0)
                {
                    Debug.WriteLine($"--- Level3 header '{row.Content}' won't fit ({currentPageUsedHeight} + {headerWithContentHeight} > {availableHeight}) - starting new page ---");
                    FillWithBlankRows(currentPageRows, availableHeight - currentPageUsedHeight);
                    pages.Add(CreatePage(pageHeader, currentLevel2Header, currentPageRows, !isFirstPageForLevel2));
                    pageNum++;
                    isFirstPageForLevel2 = false;
                    currentPageRows = new List<PrintableFormItem>();
                    currentPageUsedHeight = 0;
                }
            }

            // Check if row fits on current page
            if (currentPageUsedHeight + rowHeight > availableHeight)
            {
                Debug.WriteLine($"--- Row won't fit ({currentPageUsedHeight} + {rowHeight} > {availableHeight}) - starting new page ---");
                FillWithBlankRows(currentPageRows, availableHeight - currentPageUsedHeight);
                pages.Add(CreatePage(pageHeader, currentLevel2Header, currentPageRows, !isFirstPageForLevel2));
                pageNum++;
                isFirstPageForLevel2 = false;
                currentPageRows = new List<PrintableFormItem>();
                currentPageUsedHeight = 0;
            }

            // Add row to current page
            currentPageRows.Add(row);
            currentPageUsedHeight += rowHeight;
            Debug.WriteLine($"Added row '{row.Content}' ({row.Type}) - Page height now: {currentPageUsedHeight}px");
        }

        // Add final page
        if (currentPageRows.Count > 0)
        {
            Debug.WriteLine($"--- Finishing final page {pageNum} with {currentPageRows.Count} rows ---");
            FillWithBlankRows(currentPageRows, availableHeight - currentPageUsedHeight);
            pages.Add(CreatePage(pageHeader, currentLevel2Header, currentPageRows, !isFirstPageForLevel2));
        }

        // Update page numbers
        for (int i = 0; i < pages.Count; i++)
        {
            pages[i]. PageNumber = i + 1;
            pages[i].TotalPages = pages.Count;
        }

        Debug.WriteLine($"=== PaginateContent END - Created {pages.Count} pages ===");
        return pages;
    }

    private void FillWithBlankRows(List<PrintableFormItem> rows, double remainingHeight)
    {
        int blanksAdded = 0;
        while (remainingHeight >= BlankRowHeight)
        {
            rows.Add(new PrintableFormItem { Type = RowType.Blank, Content = string.Empty });
            remainingHeight -= BlankRowHeight;
            blanksAdded++;
        }
        Debug.WriteLine($"Filled with {blanksAdded} blank rows");
    }

    private PrintablePage CreatePage(
        string pageHeader,
        string level2Header,
        List<PrintableFormItem> rows,
        bool isContinuationPage)
    {
        return new PrintablePage
        {
            PageHeader = pageHeader,
            Level2Header = level2Header,
            Rows = new List<PrintableFormItem>(rows),
            IsContinuationPage = isContinuationPage
        };
    }
}
