using AIM.Models;
using System;
using System. Collections.Generic;
using System. Diagnostics;

namespace AIM.Services;

public class PrintPaginationService : IPrintPaginationService
{
    // Page dimensions at 96 DPI (8.5" x 11" letter size)
    private const double PageHeight = 1056;
    private const double PageWidth = 816;
    private const double TopMargin = 40;
    private const double BottomMargin = 40;

    // Element heights - ADJUST THESE to match your actual rendered sizes
    private const double HeaderHeight = 60;
    private const double Level2HeaderHeight = 35;
    private const double Level3HeaderHeight = 24;
    private const double FileRowHeight = 20;
    private const double BlankRowHeight = 20;
    private const double FooterHeight = 40;

    // Minimum rows to include with a header
    private const int MinRowsWithLevel2Header = 3;
    private const int MinRowsWithLevel3Header = 8;

    public static List<string> PaginationLog { get; } = new List<string>();

    private static void Log(string message)
    {
        PaginationLog.Add(message);
        Debug.WriteLine(message);
    }

    private double GetAvailableContentHeight(bool hasLevel2Header)
    {
        double usedHeight = TopMargin + BottomMargin + HeaderHeight + FooterHeight;
        if (hasLevel2Header)
        {
            usedHeight += Level2HeaderHeight;
        }
        return PageHeight - usedHeight;
    }

    private double GetRowHeight(PrintableFormItem item)
    {
        return item. Type switch
        {
            RowType. Level2Header => Level2HeaderHeight,
            RowType.Level3Header_A => Level3HeaderHeight,
            RowType. Level3Header_B => Level3HeaderHeight,
            RowType.Level3Header_C => Level3HeaderHeight,
            RowType.File => FileRowHeight,
            RowType.Blank => BlankRowHeight,
            _ => FileRowHeight
        };
    }

    private bool IsLevel3Header(RowType type)
    {
        return type == RowType.Level3Header_A ||
               type == RowType.Level3Header_B ||
               type == RowType.Level3Header_C;
    }

    /// <summary>
    /// Collects a Level 3 header and ALL its content rows (until next header or end). 
    /// </summary>
    private List<PrintableFormItem> CollectLevel3Section(List<PrintableFormItem> allRows, int headerIndex, out int nextIndex)
    {
        var section = new List<PrintableFormItem>();
        section.Add(allRows[headerIndex]); // Add the header

        int i = headerIndex + 1;
        while (i < allRows. Count)
        {
            var row = allRows[i];
            // Stop if we hit another header
            if (row.Type == RowType.Level2Header || IsLevel3Header(row.Type))
            {
                break;
            }
            section.Add(row);
            i++;
        }

        nextIndex = i;
        return section;
    }

    /// <summary>
    /// Calculates total height of a list of rows.
    /// </summary>
    private double CalculateSectionHeight(List<PrintableFormItem> rows)
    {
        double height = 0;
        foreach (var row in rows)
        {
            height += GetRowHeight(row);
        }
        return height;
    }

    public List<PrintablePage> PaginateContent(string pageHeader, List<PrintableFormItem> allRows)
    {
        PaginationLog.Clear();
        Log($"=== PAGINATION START: {allRows.Count} total rows ===");

        var pages = new List<PrintablePage>();
        var currentPageRows = new List<PrintableFormItem>();
        double currentPageUsedHeight = 0;
        string currentLevel2Header = string.Empty;
        double availableHeight = GetAvailableContentHeight(false);
        bool isFirstPageForLevel2 = true;

        int i = 0;
        while (i < allRows.Count)
        {
            var row = allRows[i];
            double rowHeight = GetRowHeight(row);

            bool isLevel2 = row.Type == RowType. Level2Header;
            bool isLevel3 = IsLevel3Header(row.Type);

            // ===== LEVEL 2 HEADER =====
            if (isLevel2)
            {
                // Finish current page if it has content
                if (currentPageRows.Count > 0)
                {
                    Log($">> NEW PAGE (Level2 '{row.Content}') - finishing page with {currentPageRows.Count} rows");
                    FillWithBlankRows(currentPageRows, availableHeight - currentPageUsedHeight);
                    pages.Add(CreatePage(pageHeader, currentLevel2Header, currentPageRows, !isFirstPageForLevel2));
                    currentPageRows = new List<PrintableFormItem>();
                    currentPageUsedHeight = 0;
                }

                currentLevel2Header = row.Content;
                availableHeight = GetAvailableContentHeight(true);
                isFirstPageForLevel2 = true;
                Log($"=== Level2: '{currentLevel2Header}' - Available: {availableHeight}px ===");
                i++;
                continue;
            }

            // ===== LEVEL 3 HEADER - Collect entire section =====
            if (isLevel3)
            {
                int nextIndex;
                var section = CollectLevel3Section(allRows, i, out nextIndex);
                double sectionHeight = CalculateSectionHeight(section);

                Log($"Level3 section '{row.Content}': {section.Count} rows, {sectionHeight}px total");

                // Check if entire section fits on current page
                if (currentPageUsedHeight + sectionHeight <= availableHeight)
                {
                    // Entire section fits - add it all
                    Log($"  Section fits on current page ({currentPageUsedHeight} + {sectionHeight} <= {availableHeight})");
                    foreach (var sectionRow in section)
                    {
                        currentPageRows. Add(sectionRow);
                        currentPageUsedHeight += GetRowHeight(sectionRow);
                    }
                }
                else if (sectionHeight <= availableHeight)
                {
                    // Section fits on a fresh page - start new page first
                    Log($"  Section needs new page (fits on empty page: {sectionHeight} <= {availableHeight})");
                    if (currentPageRows.Count > 0)
                    {
                        FillWithBlankRows(currentPageRows, availableHeight - currentPageUsedHeight);
                        pages.Add(CreatePage(pageHeader, currentLevel2Header, currentPageRows, !isFirstPageForLevel2));
                        isFirstPageForLevel2 = false;
                    }
                    
                    currentPageRows = new List<PrintableFormItem>();
                    currentPageUsedHeight = 0;

                    // Add entire section to new page
                    foreach (var sectionRow in section)
                    {
                        currentPageRows.Add(sectionRow);
                        currentPageUsedHeight += GetRowHeight(sectionRow);
                    }
                }
                else
                {
                    // Section is too large for one page - need to split it
                    Log($"  Section too large for one page ({sectionHeight} > {availableHeight}) - splitting");
                    
                    // Start new page if current has content
                    if (currentPageRows.Count > 0)
                    {
                        FillWithBlankRows(currentPageRows, availableHeight - currentPageUsedHeight);
                        pages. Add(CreatePage(pageHeader, currentLevel2Header, currentPageRows, !isFirstPageForLevel2));
                        isFirstPageForLevel2 = false;
                        currentPageRows = new List<PrintableFormItem>();
                        currentPageUsedHeight = 0;
                    }

                    // Add rows from section, breaking pages as needed
                    foreach (var sectionRow in section)
                    {
                        double sectionRowHeight = GetRowHeight(sectionRow);

                        if (currentPageUsedHeight + sectionRowHeight > availableHeight)
                        {
                            // Start new page
                            FillWithBlankRows(currentPageRows, availableHeight - currentPageUsedHeight);
                            pages.Add(CreatePage(pageHeader, currentLevel2Header, currentPageRows, !isFirstPageForLevel2));
                            isFirstPageForLevel2 = false;
                            currentPageRows = new List<PrintableFormItem>();
                            currentPageUsedHeight = 0;
                        }

                        currentPageRows.Add(sectionRow);
                        currentPageUsedHeight += sectionRowHeight;
                    }
                }

                i = nextIndex; // Skip past the section we just processed
                continue;
            }

            // ===== REGULAR ROW (File or Blank not part of Level3 section) =====
            if (currentPageUsedHeight + rowHeight > availableHeight)
            {
                Log($">> NEW PAGE (row won't fit)");
                FillWithBlankRows(currentPageRows, availableHeight - currentPageUsedHeight);
                pages.Add(CreatePage(pageHeader, currentLevel2Header, currentPageRows, !isFirstPageForLevel2));
                isFirstPageForLevel2 = false;
                currentPageRows = new List<PrintableFormItem>();
                currentPageUsedHeight = 0;
            }

            currentPageRows.Add(row);
            currentPageUsedHeight += rowHeight;
            i++;
        }

        // Add final page
        if (currentPageRows.Count > 0)
        {
            Log($">> FINAL PAGE - {currentPageRows.Count} rows");
            FillWithBlankRows(currentPageRows, availableHeight - currentPageUsedHeight);
            pages.Add(CreatePage(pageHeader, currentLevel2Header, currentPageRows, !isFirstPageForLevel2));
        }

        // Update page numbers
        for (int p = 0; p < pages. Count; p++)
        {
            pages[p]. PageNumber = p + 1;
            pages[p].TotalPages = pages.Count;
        }

        Log($"=== PAGINATION END: {pages.Count} pages created ===");
        return pages;
    }

    private void FillWithBlankRows(List<PrintableFormItem> rows, double remainingHeight)
    {
        while (remainingHeight >= BlankRowHeight)
        {
            rows.Add(new PrintableFormItem { Type = RowType. Blank, Content = string.Empty });
            remainingHeight -= BlankRowHeight;
        }
    }

    private PrintablePage CreatePage(
        string pageHeader,
        string level2Header,
        List<PrintableFormItem> rows,
        bool isContinuationPage)
    {
        return new PrintablePage
        {
            PageHeader = pageHeader,
            Level2Header = level2Header,
            Rows = new List<PrintableFormItem>(rows),
            IsContinuationPage = isContinuationPage
        };
    }
}
